<div class="ticket-admin">
  <div class="ticket-summary glass-container">
    @for (status of ticketStatuses(); track status._id) {
    <div class="ticket-card {{ status.cssClass }}" (click)="onCardClick(status._id!)">
      <mat-icon class="ticket-icon">
        {{ getStatusIcon(status.cssClass) }}
      </mat-icon>
      <div class="ticket-title">{{ status.name }}</div>
      <div class="ticket-count">{{ countByStatus(status._id!) }}</div> <!-- ✅ aquí -->
    </div>
    }



    <div class="ticket-card total" (click)="onCardClick('Todos')">
      <mat-icon class="ticket-icon">confirmation_number</mat-icon>
      <div class="ticket-title">Total</div>
      <div class="ticket-count">{{ totalTickets() }}</div>
    </div>
  </div>

  <div class="glass-container status-chips">
    <div class="chip verde" (click)="setFilterSemaforo('verde')">
      <span class="color-dot"></span>
      <span class="label">A tiempo</span>
      <span class="count">{{ countSemaforoColor('verde') }}</span>
    </div>

    <div class="chip ambar" (click)="setFilterSemaforo('ambar')">
      <span class="color-dot"></span>
      <span class="label">Requieren atención</span>
      <span class="count">{{ countSemaforoColor('ambar') }}</span>
    </div>

    <div class="chip rojo" (click)="setFilterSemaforo('rojo')">
      <span class="color-dot"></span>
      <span class="label">Vencidos</span>
      <span class="count">{{ countSemaforoColor('rojo') }}</span>
    </div>
    <div class="chip dark" (click)="clearSemaforoFilter()">
      <span class="color-dot"></span>
      <span class="label">Todos</span>
      <span class="count">{{ totalTickets() }}</span>
    </div>
  </div>

  <div class="filter-row glass-container">
    @if (isAdminOrAtencion) {
    <mat-form-field appearance="outline">
      <mat-label>Área</mat-label>
      <mat-select [formControl]="columnFilters.controls['area']" (selectionChange)="onColumnFilterChange()">
        <mat-option value="">Todas</mat-option>
        @for (a of areas(); track a._id) {
        <mat-option [value]="a._id">{{ a.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
    }

    <mat-form-field appearance="outline">
      <mat-label>Problema</mat-label>
      <mat-select [formControl]="columnFilters.controls['problem']" (selectionChange)="onColumnFilterChange()">
        <mat-option value="">Todos</mat-option>
        @for (p of visibleProblems(); track p._id) {
        <mat-option [value]="p._id">{{ p.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Rango de fechas</mat-label>
      <mat-date-range-input [formGroup]="columnFilters" [rangePicker]="picker">
        <input matStartDate formControlName="startDate" placeholder="Desde" (dateChange)="onColumnFilterChange()" />
        <input matEndDate formControlName="endDate" placeholder="Hasta" (dateChange)="onColumnFilterChange()" />
      </mat-date-range-input>
      <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-date-range-picker #picker></mat-date-range-picker>
    </mat-form-field>



    <mat-form-field appearance="outline">
      <mat-label>Estado</mat-label>
      <mat-select [formControl]="columnFilters.controls['status']" (selectionChange)="onColumnFilterChange()">
        <mat-option value="">Todos</mat-option>
        @for (s of ticketStatuses(); track s._id) {
        <mat-option [value]="s._id">{{ s.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>


  </div>


  <section class="search-bar glass-container">
    <div class="search-wrapper">
      <mat-icon class="search-icon">search</mat-icon>
      <input type="text" class="search-input" placeholder="Buscar tickets..."
        (input)="setSearch($any($event.target).value)" />
    </div>
  </section>




  <div class="glass-container">
    <table mat-table [dataSource]="ticketsSignal()" aria-label="Tabla de tickets">

      <ng-container matColumnDef="folio">
        <th mat-header-cell *matHeaderCellDef mat-sort-header (click)="sortBy('folio')">
          Folio {{ getSortIndicator('folio') }}
        </th>
        <td mat-cell *matCellDef="let ticket">
          <span class="badge folio-badge">#{{ ticket.folio }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="problem">
        <th mat-header-cell *matHeaderCellDef mat-sort-header (click)="sortBy('problem')">
          Problema {{ getSortIndicator('problem') }}
        </th>
        <td mat-cell *matCellDef="let ticket">
  <span class="badge badge-problema">{{ getProblemName(ticket.problem) }}</span>
</td>
      </ng-container>

      <ng-container matColumnDef="area">
        <th mat-header-cell *matHeaderCellDef>Área</th>
        <td mat-cell *matCellDef="let ticket">
          @if (ticket.areaAssignments?.length) {
          <span class="badge area-badge">
            {{ getAreaName(ticket.areaAssignments.at(-1)?.area) }}
          </span>
          <mat-icon [ngClass]="getAreaStatusIconColor(ticket)" [matTooltip]="getAreaStatusTooltip(ticket)"
            class="area-status-icon">
            {{ getAreaStatusIcon(ticket) }}
          </mat-icon>
          } @else {
          @if (hasAreaRejection(ticket)) {
          <span class="text-warn badge">Rechazado</span>
          <button mat-icon-button [matTooltip]="'Ver detalles de rechazo'" (click)="openRejectionDialog(ticket)">
            <mat-icon color="warn">info</mat-icon>
          </button>
          } @else {
          <span class="badge area-badge">Sin asignar</span>
          }
          }
        </td>
      </ng-container>

      <ng-container matColumnDef="cuadrilla">
        <th mat-header-cell *matHeaderCellDef>Cuadrilla</th>
        <td mat-cell *matCellDef="let ticket">
          @if (ticket.crewAssignments?.length) {
          <span class="badge crew-badge">
            {{ getCuadrillaName(ticket.crewAssignments.at(-1)?.cuadrilla) }}
          </span>
          <mat-icon [ngClass]="getCrewStatusIconColor(ticket)" [matTooltip]="getCrewStatusTooltip(ticket)"
            class="crew-status-icon">
            {{ getCrewStatusIcon(ticket) }}
          </mat-icon>
          } @else {
          @if (hasCrewRejection(ticket)) {
          <span class="text-warn badge">Rechazado</span>
          <button mat-icon-button [matTooltip]="'Ver detalles de rechazo'" (click)="openRejectionDialog(ticket)">
            <mat-icon color="warn">info</mat-icon>
          </button>
          } @else {
          <span class="badge crew-badge">Sin asignar</span>
          }
          }
        </td>
      </ng-container>


      <ng-container matColumnDef="createdAt">
        <th mat-header-cell *matHeaderCellDef mat-sort-header (click)="sortBy('createdAt')">
          Creado el {{ getSortIndicator('createdAt') }}
        </th>
        <td mat-cell *matCellDef="let ticket">
  <span class="badge badge-fecha">{{ ticket.createdAt | date: 'dd/MM/yyyy' }}</span>
</td>
      </ng-container>



      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let ticket">
          <span class="status-badge" [ngClass]="getStatusCssClass(ticket.status)">
            {{ getStatusName(ticket.status) }}
          </span>
        </td>

      </ng-container>

      <ng-container matColumnDef="semaforo">
        <th mat-header-cell *matHeaderCellDef>Semáforo</th>
        <td mat-cell *matCellDef="let ticket">
          <span class="semaforo-dot" [ngClass]="getSemaforoColor(ticket.createdAt)"></span>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let ticket">
          <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Más acciones" matTooltip="Acciones">
            <mat-icon>more_vert</mat-icon>
          </button>

          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="editTicket(ticket)">
              <mat-icon>edit</mat-icon>
              <span>Ver Ticket/Editar</span>
            </button>

            @if(isAdmin){
            <button mat-menu-item (click)="deleteTicket(ticket._id)">
              <mat-icon color="warn">delete</mat-icon>
              <span>Eliminar</span>
            </button>
            }

            @if (isAdminOrAtencionOrFuncionario) {
            <button mat-menu-item (click)="openAssignmentDialog(ticket)">
              <mat-icon>assignment_ind</mat-icon>
              <span>Asignar</span>
            </button>
            }

            @if (canRespondToAssignment(getRespondableAssignment(ticket))) {
            <button mat-menu-item (click)="respondToAssignment(ticket._id, true)">
              <mat-icon color="primary">check</mat-icon>
              <span>Aceptar</span>
            </button>

            <button mat-menu-item (click)="respondToAssignment(ticket._id, false)">
              <mat-icon color="warn">close</mat-icon>
              <span>Rechazar</span>
            </button>
            }
          </mat-menu>
        </td>
      </ng-container>



      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns" [class.closed-ticket-row]="isClosed(row)"></tr>
    </table>
  </div>

  <mat-paginator [length]="totalTickets()" [pageSize]="pageSize()" [pageIndex]="page() - 1"
    [pageSizeOptions]="[5, 10, 15, 20]" showFirstLastButtons (page)="onPageChange($event)">
  </mat-paginator>

</div>