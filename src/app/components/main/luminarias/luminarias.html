<div class="luminarias-page" [@fadeInOut]>
  <header class="hero glass-card">
    <div class="hero-copy">
      <span class="eyebrow">Infraestructura urbana</span>
      <h1>Panel de Luminarias</h1>
      <p class="subtitle">Inventario vivo con estados operativos, ubicacion y mantenimiento.</p>
      <div class="hero-meta">
        <div class="meta-pill">
          <mat-icon>schedule</mat-icon>
          <span>Actualizado {{ lastUpdated ? (lastUpdated | date:'short') : '—' }}</span>
        </div>
        <div class="meta-pill">
          <mat-icon>location_on</mat-icon>
          <span>{{ totalCount() }} puntos registrados</span>
        </div>
      </div>
    </div>
    <div class="hero-stats">
      <div class="stat-card">
        <span class="label">Total</span>
        <span class="value">{{ totalCount() }}</span>
      </div>
      <div class="stat-card tone-good">
        <span class="label">Operativas</span>
        <span class="value">{{ statusCounts().good }}</span>
      </div>
      <div class="stat-card tone-warn">
        <span class="label">Atencion</span>
        <span class="value">{{ statusCounts().warn }}</span>
      </div>
      <div class="stat-card tone-bad">
        <span class="label">Fuera</span>
        <span class="value">{{ statusCounts().bad }}</span>
      </div>
    </div>
  </header>

  <section class="controls glass-card">
    <div class="search-block">
      <mat-form-field appearance="outline" class="glass-field">
        <mat-label>Buscar luminaria</mat-label>
        <input matInput (input)="applyFilter($event)" placeholder="Codigo, tipo, estado, coordenadas..." />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
      <button mat-icon-button class="refresh-btn" (click)="reload()" matTooltip="Actualizar">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
    <div class="status-rail">
      <button type="button" class="chip" [class.active]="statusFilter === 'all'" (click)="setStatusFilter('all')">
        Todas <span class="count">{{ totalCount() }}</span>
      </button>
      <button type="button" class="chip tone-good" [class.active]="statusFilter === 'good'" (click)="setStatusFilter('good')">
        Operativas <span class="count">{{ statusCounts().good }}</span>
      </button>
      <button type="button" class="chip tone-warn" [class.active]="statusFilter === 'warn'" (click)="setStatusFilter('warn')">
        Atencion <span class="count">{{ statusCounts().warn }}</span>
      </button>
      <button type="button" class="chip tone-bad" [class.active]="statusFilter === 'bad'" (click)="setStatusFilter('bad')">
        Fuera <span class="count">{{ statusCounts().bad }}</span>
      </button>
      <button type="button" class="chip tone-neutral" [class.active]="statusFilter === 'neutral'" (click)="setStatusFilter('neutral')">
        Sin estado <span class="count">{{ statusCounts().neutral }}</span>
      </button>
    </div>
    <div class="status-hint" *ngIf="statusFilter !== 'all'">
      Filtrando por: {{ statusToneLabel(statusFilter) }}
      <button type="button" class="link" (click)="setStatusFilter('all')">Ver todas</button>
    </div>
  </section>

  <section class="content-grid">
    <div class="list-panel glass-card" [@fadeInOut]>
      <div class="panel-header">
        <div class="panel-title">
          <mat-icon>lightbulb</mat-icon>
          <div>
            <h2>Luminarias registradas</h2>
            <p>{{ totalCount() }} elementos en inventario</p>
          </div>
        </div>
        <div class="panel-actions">
          <button mat-stroked-button (click)="clearSelection()" [disabled]="!selectedLuminaria">
            Limpiar detalle
          </button>
        </div>
      </div>

      <div class="table-wrapper">
        <table mat-table [dataSource]="dataSource" matSort>
          <ng-container matColumnDef="code">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Codigo</th>
            <td mat-cell *matCellDef="let row">
              <div class="code-cell">
                <span class="code">{{ row.code || row._id }}</span>
                <span class="subtle">{{ row._id }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
            <td mat-cell *matCellDef="let row">
              <div class="type-cell">
                <mat-icon>flare</mat-icon>
                <span>{{ row.type || '—' }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="power">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Potencia</th>
            <td mat-cell *matCellDef="let row">
              <span class="pill">{{ row.power != null ? row.power + ' W' : '—' }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="voltage">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Voltaje</th>
            <td mat-cell *matCellDef="let row">
              <span class="pill soft">{{ row.voltage != null ? row.voltage + ' V' : '—' }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="poleHeight">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Altura</th>
            <td mat-cell *matCellDef="let row">
              <span>{{ row.poleHeight != null ? row.poleHeight + ' m' : '—' }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="location">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Ubicacion</th>
            <td mat-cell *matCellDef="let row">
              <div class="location-cell">
                <mat-icon>location_on</mat-icon>
                <span>{{ row.coordsLabel }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
            <td mat-cell *matCellDef="let row">
              <span class="status-chip" [ngClass]="'tone-' + row.statusTone">
                {{ row.statusLabel }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="lastMaintenance">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Ultima atencion</th>
            <td mat-cell *matCellDef="let row">
              <div class="maintenance-cell">
                <span>{{ row.lastMaintenanceDate ? (row.lastMaintenanceDate | date:'mediumDate') : '—' }}</span>
                <span class="subtle">{{ row.maintenanceCount }} eventos</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let row">
              <button mat-icon-button color="primary" (click)="selectLuminaria(row)" matTooltip="Ver detalle">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button color="accent" (click)="printLuminaria()" [disabled]="!selectedLuminaria || selectedLuminaria._id !== row._id" matTooltip="Imprimir ficha">
                <mat-icon>print</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.selected]="selectedLuminaria?._id === row._id"></tr>
        </table>

        <div class="state-message" *ngIf="loading">
          <mat-icon>sync</mat-icon>
          <span>Cargando luminarias...</span>
        </div>

        <div class="state-message error" *ngIf="errorMessage">
          <mat-icon>error</mat-icon>
          <span>{{ errorMessage }}</span>
        </div>

        <div class="state-message empty" *ngIf="!loading && !errorMessage && !dataSource.data.length">
          <mat-icon>info</mat-icon>
          <span>No hay luminarias registradas.</span>
        </div>
      </div>

      <mat-paginator [pageSizeOptions]="[10, 25, 50]" showFirstLastButtons></mat-paginator>
    </div>

    <aside class="details-panel glass-card" *ngIf="selectedLuminaria; else emptyDetail" [@fadeInOut]>
      <div class="details-header">
        <div>
          <p class="eyebrow">Detalle</p>
          <h2>{{ selectedLuminaria.code || selectedLuminaria._id }}</h2>
          <span class="status-chip" [ngClass]="'tone-' + selectedLuminaria.statusTone">
            {{ selectedLuminaria.statusLabel }}
          </span>
        </div>
        <button mat-icon-button (click)="clearSelection()" matTooltip="Cerrar">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="details-grid">
        <div class="detail-card">
          <span class="label">Tipo</span>
          <span class="value">{{ selectedLuminaria.type || '—' }}</span>
        </div>
        <div class="detail-card">
          <span class="label">Potencia</span>
          <span class="value">{{ selectedLuminaria.power != null ? selectedLuminaria.power + ' W' : '—' }}</span>
        </div>
        <div class="detail-card">
          <span class="label">Voltaje</span>
          <span class="value">{{ selectedLuminaria.voltage != null ? selectedLuminaria.voltage + ' V' : '—' }}</span>
        </div>
        <div class="detail-card">
          <span class="label">Altura</span>
          <span class="value">{{ selectedLuminaria.poleHeight != null ? selectedLuminaria.poleHeight + ' m' : '—' }}</span>
        </div>
        <div class="detail-card">
          <span class="label">Instalada</span>
          <span class="value">{{ selectedLuminaria.installationDate ? (selectedLuminaria.installationDate | date:'mediumDate') : '—' }}</span>
        </div>
        <div class="detail-card">
          <span class="label">Coordenadas</span>
          <span class="value">{{ selectedLuminaria.coordsLabel }}</span>
        </div>
        <div class="detail-card wide">
          <span class="label">Ultima atencion</span>
          <span class="value">
            {{ selectedLuminaria.lastMaintenanceDate ? (selectedLuminaria.lastMaintenanceDate | date:'mediumDate') : '—' }}
          </span>
          <span class="meta" *ngIf="daysSince(selectedLuminaria.lastMaintenanceDate) !== null">
            {{ daysSince(selectedLuminaria.lastMaintenanceDate) }} dias desde la ultima atencion
          </span>
        </div>
        <div class="detail-card wide">
          <span class="label">Notas recientes</span>
          <span class="value">{{ selectedLuminaria.lastMaintenanceNote || 'Sin observaciones' }}</span>
        </div>
      </div>

      <div class="detail-section">
        <h3>Mantenimiento reciente</h3>
        <div class="maintenance-list" *ngIf="selectedLuminaria.maintenancePreview?.length; else emptyMaint">
          <div class="maintenance-item" *ngFor="let m of selectedLuminaria.maintenancePreview">
            <div class="maintenance-date">
              <mat-icon>event</mat-icon>
              <span>{{ m.date ? (m.date | date:'mediumDate') : '—' }}</span>
            </div>
            <p class="maintenance-desc">{{ m.description || m.observations || 'Sin descripcion registrada' }}</p>
          </div>
        </div>
        <ng-template #emptyMaint>
          <p class="empty-block">No hay mantenimientos recientes registrados.</p>
        </ng-template>
      </div>

      <div class="detail-section" *ngIf="selectedMapUrl; else noMap">
        <h3>Ubicacion</h3>
        <div class="map-shell">
          <iframe [src]="selectedMapUrl" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
      </div>
      <ng-template #noMap>
        <div class="detail-section">
          <h3>Ubicacion</h3>
          <p class="empty-block">Sin coordenadas disponibles.</p>
        </div>
      </ng-template>
    </aside>

    <ng-template #emptyDetail>
      <aside class="details-panel glass-card empty">
        <div class="empty-state">
          <mat-icon>lightbulb</mat-icon>
          <h3>Selecciona una luminaria</h3>
          <p>Explora el listado para ver el detalle y el historial.</p>
        </div>
      </aside>
    </ng-template>
  </section>
</div>
